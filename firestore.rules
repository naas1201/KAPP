rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for reusable logic
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingDoc() {
      return resource != null;
    }

    /**
     * Checks if the requesting user is an authorized doctor for a given patient.
     * Authorization is determined by the existence of a document in the doctor's
     * own patient list. This is a performant denormalized ACL check.
     */
    function isAuthorizedDoctor(patientId) {
      return isSignedIn() && exists(/databases/$(database)/documents/doctors/$(request.auth.uid)/authorizedPatients/$(patientId));
    }
    
    /**
     * Grants access if the user is the patient themselves or an authorized doctor.
     */
    function canAccessPatientData(patientId) {
      return isOwner(patientId) || isAuthorizedDoctor(patientId);
    }
    
    // Admins have special privileges. This could be based on a custom claim.
    function isAdmin() {
      return request.auth.token.admin == true;
    }

    /**
     * @description Manages patient profiles. Only the patient can create. Patient or authorized doctor can read/update it.
     */
    match /patients/{patientId} {
      allow get, update: if canAccessPatientData(patientId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(patientId);
      allow delete: if isOwner(patientId) || isAdmin();

      /**
       * @description Secures patient appointments, treatment records, and prescriptions.
       * Access is inherited from the parent patient document.
       */
      match /{subcollection}/{docId} {
        allow read, write: if canAccessPatientData(patientId) || isAdmin();
      }
    }

    /**
     * @description Manages doctor profiles. Profiles are readable by any authenticated user.
     */
    match /doctors/{doctorId} {
      allow get, list: if isSignedIn();
      allow create: if isOwner(doctorId);
      allow update: if isOwner(doctorId) || isAdmin();
      allow delete: if isAdmin();
      
      /**
       * @description This path is an Access Control List (ACL). It links doctors to patients they can access.
       * Only admins can grant/revoke doctor access to a patient.
       */
      match /authorizedPatients/{patientId} {
        allow read, write: if isAdmin();
      }
    }

    /**
     * @description Stores leads from contact forms. Writable by any authenticated source, but manageable only by staff.
     */
    match /leads/{leadId} {
      allow read, list: if isAdmin();
      allow create: if isSignedIn();
      allow update, delete: if isAdmin();
    }

    /**
     * @description Stores public Frequently Asked Questions. Readable by anyone. Writable by admin.
     */
    match /faqs/{faqId} {
      allow get, list: if true;
      allow write: if isAdmin();
    }
  }
}
