rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ==========================================================
    // 1. HELPER FUNCTIONS (OWASP & SECURITY)
    // ==========================================================
    
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // FIX: Retrieve role using UID, NOT Email
    function getUserRole(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }

    function isDoctor() {
      return isSignedIn() && getUserRole(request.auth.uid) == 'doctor';
    }

    function isAdmin() {
       return isSignedIn() && getUserRole(request.auth.uid) == 'admin';
    }

    // Helper to check if user is staff (admin or doctor)
    function isStaff() {
      return isAdmin() || isDoctor();
    }

    // OWASP: Input validation - Check string length to prevent DoS
    function isValidStringLength(str, maxLength) {
      return str is string && str.size() <= maxLength;
    }
    
    // OWASP: Validate email format
    function isValidEmailFormat(email) {
      return email is string 
        && email.matches('^[a-zA-Z0-9]([a-zA-Z0-9._%-]*[a-zA-Z0-9])?@[a-zA-Z0-9]([a-zA-Z0-9.-]*[a-zA-Z0-9])?\\.[a-zA-Z]{2,}$')
        && email.size() <= 254
        && !email.matches('.*\\.\\..+'); 
    }

    // OWASP: Prevent script injection in text fields
    function noScriptTags(str) {
      return str is string 
        && !str.lower().matches('.*<script.*')
        && !str.lower().matches('.*javascript:.*')
        && !str.lower().matches('.*on[a-z]+\\s*=.*');
    }
    
    // OWASP: Validate document size to prevent DoS
    function isValidDocumentSize() {
      return request.resource.data.keys().size() <= 100;
    }

    // ==========================================================
    // 2. COLLECTION RULES
    // ==========================================================

    /**
     * @description Stores user roles and profile data.
     * Document ID MUST be the Auth UID (request.auth.uid) for security.
     * Role lookup functions (getUserRole, isAdmin, isDoctor) depend on this.
     */
    match /users/{userId} {
      // Allow read if you are the owner (UID match) OR if you are Admin
      allow read: if isOwner(userId) || isAdmin();
      
      // Allow users to create their own document during sign-up
      // Must use their UID as document ID and email must match auth token
      // Default role must be 'patient' - only admins can assign 'admin' or 'doctor'
      allow create: if isSignedIn() 
        && isOwner(userId)
        && request.resource.data.email == request.auth.token.email
        && isValidEmailFormat(request.resource.data.email)
        && request.resource.data.role == 'patient'
        && isValidDocumentSize();
      
      // Only admins can update user documents (e.g., to change roles)
      allow update: if isAdmin();
      
      // Only admins can delete user documents
      allow delete: if isAdmin();
    }

    /**
     * @description Staff credentials for authentication.
     * This collection is publicly readable to allow staff login verification
     * but only contains the minimal data needed (email, role, accessCode).
     * Sensitive user data remains protected in the users collection.
     */
    match /staffCredentials/{credentialId} {
      // Allow read for anyone - needed for staff login to verify credentials
      allow read: if true;
      // Only admins can create or modify staff credentials
      allow write: if isAdmin();
    }

    /**
     * @description Pending staff invites. Admin can create invites by email.
     * When users sign up, they check this collection to see if they have a pending invite.
     * Public read is required so signup process can check for pending invites.
     */
    match /pendingStaff/{email} {
      // Allow read for anyone - needed during signup to check for pending invites
      allow read: if true;
      // Only admins can create, update, or delete pending invites
      allow write: if isAdmin();
      // Allow authenticated users to delete their own pending invite (when claiming it during signup)
      allow delete: if isSignedIn() && request.auth.token.email == email;
    }

    /**
     * Checks if the requesting user is an authorized doctor for a given patient.
     */
    function isAuthorizedDoctorForPatient(patientId) {
      return isDoctor() && exists(/databases/$(database)/documents/doctors/$(request.auth.uid)/authorizedPatients/$(patientId));
    }
    
    /**
     * Grants access if the user is the patient themselves or an authorized doctor for them.
     */
    function canAccessPatientData(patientId) {
      return isOwner(patientId) || isAuthorizedDoctorForPatient(patientId) || isAdmin();
    }

    /**
     * @description Manages patient profiles. 
     */
    match /patients/{patientId} {
      allow get: if canAccessPatientData(patientId);
      allow update: if canAccessPatientData(patientId) && isValidDocumentSize();
      allow list: if isAdmin();
      allow create: if isOwner(patientId) 
        && isValidDocumentSize()
        && isValidStringLength(request.resource.data.firstName, 100)
        && isValidStringLength(request.resource.data.lastName, 100)
        && noScriptTags(request.resource.data.firstName)
        && noScriptTags(request.resource.data.lastName);
      allow delete: if isAdmin();

      match /appointments/{appointmentId} {
        // Allow patient to read their own appointments, or authorized doctors/admins
        // Also allow any doctor to read pending appointments so they can approve them
        allow read: if canAccessPatientData(patientId)
          || (isDoctor() && resource.data.keys().hasAny(['status']) && resource.data.status == 'pending');
        
        // Patient can create appointments for themselves with validation
        allow create: if canAccessPatientData(patientId)
          && isValidDocumentSize()
          && isValidStringLength(request.resource.data.serviceType, 200)
          && noScriptTags(request.resource.data.patientNotes);
        
        // Doctors (authorized or for pending appointments) and admins can update/delete
        allow update, delete: if isAuthorizedDoctorForPatient(patientId) 
          || isAdmin()
          || (isDoctor() && resource.data.keys().hasAny(['status']) && resource.data.status == 'pending');
      }
      
      match /treatmentRecords/{recordId} {
        allow read: if canAccessPatientData(patientId);
        allow write: if (isAuthorizedDoctorForPatient(patientId) || isAdmin()) && isValidDocumentSize();
      }
      
       match /prescriptions/{prescriptionId} {
        allow read: if canAccessPatientData(patientId);
        allow write: if (isAuthorizedDoctorForPatient(patientId) || isAdmin()) 
          && isValidDocumentSize()
          && isValidStringLength(request.resource.data.prescriptionNumber, 50);
      }
    }

    /**
     * @description Publicly readable collection of all appointments (Doctors/Admin for read, patients for create)
     * This is a denormalized view of patient appointments for doctor/admin convenience.
     * Patients can create their own appointments, doctors/admins can update them.
     */
     match /appointments/{appointmentId} {
       allow read: if isDoctor() || isAdmin();
       // Patients can create appointments (patientId must match their UID)
       allow create: if isSignedIn() 
         && request.resource.data.patientId == request.auth.uid
         && isValidDocumentSize();
       // Doctors and admins can update (for approving/rejecting)
       allow update: if isDoctor() || isAdmin();
       allow delete: if isAdmin();
     }

     /**
      * @description Denormalized prescriptions (Admins Only)
      */
     match /prescriptions/{prescriptionId} {
       allow read, list: if isAdmin();
       allow write: if false; 
     }

    /**
     * @description Manages doctor profiles.
     */
    match /doctors/{doctorId} {
      allow get, list: if isSignedIn();
      allow create: if isOwner(doctorId) 
        && isValidDocumentSize();
      allow update: if isOwner(doctorId) || isAdmin();
      allow delete: if isAdmin();
      
      match /authorizedPatients/{patientId} {
        allow write: if isOwner(doctorId) || isAdmin();
        allow read: if isOwner(doctorId) || isAdmin();
      }

      match /services/{serviceId} {
        allow read: if isSignedIn();
        allow write: if isOwner(doctorId) || isAdmin();
      }

      match /customServices/{serviceId} {
        allow read: if isSignedIn();
        allow write: if isOwner(doctorId) || isAdmin();
      }

      match /patients/{patientId} {
        allow read, write: if isOwner(doctorId) || isAdmin();
      }

      // Session logs for security tracking
      match /sessionLogs/{sessionId} {
        allow read: if isOwner(doctorId) || isAdmin();
        allow create, update: if isOwner(doctorId);
        allow delete: if false; // Session logs are immutable
      }
    }

    /**
     * @description Master list of all treatments.
     */
    match /treatments/{treatmentId} {
      allow get, list: if isSignedIn();
      allow write: if isAdmin();
    }

    /**
     * @description Stores patient medical information (allergies, conditions, etc.)
     * Document ID is the patient's UID.
     */
    match /medicalInfo/{patientId} {
      // Patients can read and write their own medical info
      allow read, write: if isOwner(patientId);
      // Staff can read patient medical info for authorized patients
      allow read: if isStaff() && (isAuthorizedDoctorForPatient(patientId) || isAdmin());
    }

    /**
     * @description Stores leads from contact forms.
     */
    match /leads/{leadId} {
      allow read, list: if isAdmin();
      allow create: if true
        && isValidDocumentSize()
        && isValidStringLength(request.resource.data.name, 200)
        && isValidStringLength(request.resource.data.message, 5000)
        && noScriptTags(request.resource.data.name)
        && noScriptTags(request.resource.data.message);
      allow update, delete: if isAdmin();
    }

    /**
     * @description Public FAQs
     */
    match /faqs/{faqId} {
      allow get, list: if true;
      allow write: if isAdmin();
    }

    /**
     * @description WebRTC Video Calls
     */
    match /video-calls/{roomId} {
      allow read, write: if isSignedIn() && (isAuthorizedDoctorForPatient(resource.data.patientId) || isOwner(resource.data.patientId));
    }
    
     /**
     * @description Chat rooms
     */
    match /chatRooms/{roomId} {
      allow read, update: if isSignedIn() && request.auth.uid in resource.data.participants;
      allow create: if isDoctor();

      match /messages/{messageId} {
        allow get, list: if isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/chatRooms/$(roomId)).data.participants;
        allow create: if isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/chatRooms/$(roomId)).data.participants
                      && get(/databases/$(database)/documents/chatRooms/$(roomId)).data.status == 'open'
                      && isValidStringLength(request.resource.data.content, 10000)
                      && noScriptTags(request.resource.data.content);
        allow update: if isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/chatRooms/$(roomId)).data.participants;
      }
    }

    /**
     * @description Reports filed by doctors
     */
    match /reports/{reportId} {
      allow create: if isDoctor() 
        && isValidDocumentSize()
        && isValidStringLength(request.resource.data.reason, 5000);
      allow read, write: if isAdmin();
    }

    /**
     * @description Stores ratings for consultations.
     */
    match /ratings/{ratingId} {
      allow create: if isSignedIn()
         && isValidDocumentSize()
         && request.resource.data.rating >= 1
         && request.resource.data.rating <= 5;
      allow read, list: if isAdmin();
    }

    /**
     * @description System announcements visible to users
     */
    match /announcements/{announcementId} {
      // Users can read active announcements
      allow read: if isSignedIn();
      // Only admins can create, update, delete announcements
      allow write: if isAdmin();
    }

    /**
     * @description Feature flags for enabling/disabling features
     */
    match /featureFlags/{flagId} {
      // Anyone can read feature flags (needed for feature checks)
      allow read: if true;
      // Only admins can modify feature flags
      allow write: if isAdmin();
    }

    /**
     * @description Audit logs for tracking admin actions
     */
    match /auditLogs/{logId} {
      // Only admins can read audit logs
      allow read: if isAdmin();
      // Admins can create logs, but cannot update or delete them (immutable)
      allow create: if isAdmin();
      allow update, delete: if false;
    }
  }
}
