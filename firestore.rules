rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ==========================================================
    // 1. HELPER FUNCTIONS (OWASP & SECURITY)
    // ==========================================================
    
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // FIX: Retrieve role using UID, NOT Email
    function getUserRole(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }

    function isDoctor() {
      return isSignedIn() && getUserRole(request.auth.uid) == 'doctor';
    }

    function isAdmin() {
       return isSignedIn() && getUserRole(request.auth.uid) == 'admin';
    }

    // OWASP: Input validation - Check string length to prevent DoS
    function isValidStringLength(str, maxLength) {
      return str is string && str.size() <= maxLength;
    }
    
    // OWASP: Validate email format
    function isValidEmailFormat(email) {
      return email is string 
        && email.matches('^[a-zA-Z0-9]([a-zA-Z0-9._%-]*[a-zA-Z0-9])?@[a-zA-Z0-9]([a-zA-Z0-9.-]*[a-zA-Z0-9])?\\.[a-zA-Z]{2,}$')
        && email.size() <= 254
        && !email.matches('.*\\.\\..+'); 
    }

    // OWASP: Prevent script injection in text fields
    function noScriptTags(str) {
      return str is string 
        && !str.lower().matches('.*<script.*')
        && !str.lower().matches('.*javascript:.*')
        && !str.lower().matches('.*on[a-z]+\\s*=.*');
    }
    
    // OWASP: Validate document size to prevent DoS
    function isValidDocumentSize() {
      return request.resource.data.keys().size() <= 100;
    }

    // ==========================================================
    // 2. COLLECTION RULES
    // ==========================================================

    /**
     * @description Stores user roles. 
     * FIX APPLIED: Uses UID for ID, but checks Email for mismatch prevention.
     * NOTE: Read is allowed for unauthenticated users to enable staff login
     * which verifies credentials against stored accessCode before session creation.
     */
    match /users/{userId} {
      // Allow read for anyone - needed for staff login to verify credentials
      // The accessCode field acts as a password for staff authentication
      allow read: if true;
      // Only admins can change roles
      allow write: if isAdmin();
      
      // Allow creation only if the email in the doc matches the auth token email
      allow create: if isSignedIn() 
        && request.resource.data.email == request.auth.token.email
        && isValidEmailFormat(request.resource.data.email);
    }

    /**
     * Checks if the requesting user is an authorized doctor for a given patient.
     */
    function isAuthorizedDoctorForPatient(patientId) {
      return isDoctor() && exists(/databases/$(database)/documents/doctors/$(request.auth.uid)/authorizedPatients/$(patientId));
    }
    
    /**
     * Grants access if the user is the patient themselves or an authorized doctor for them.
     */
    function canAccessPatientData(patientId) {
      return isOwner(patientId) || isAuthorizedDoctorForPatient(patientId) || isAdmin();
    }

    /**
     * @description Manages patient profiles. 
     */
    match /patients/{patientId} {
      allow get, update: if canAccessPatientData(patientId) && isValidDocumentSize();
      allow list: if isAdmin();
      allow create: if isOwner(patientId) 
        && isValidDocumentSize()
        && isValidStringLength(request.resource.data.firstName, 100)
        && isValidStringLength(request.resource.data.lastName, 100)
        && noScriptTags(request.resource.data.firstName)
        && noScriptTags(request.resource.data.lastName);
      allow delete: if isAdmin();

      match /appointments/{appointmentId} {
        allow read, create: if canAccessPatientData(patientId)
          && isValidDocumentSize()
          && isValidStringLength(request.resource.data.serviceType, 200)
          && noScriptTags(request.resource.data.patientNotes);
        allow update, delete: if isAuthorizedDoctorForPatient(patientId) || isAdmin();
      }
      
      match /treatmentRecords/{recordId} {
        allow read: if canAccessPatientData(patientId);
        allow write: if (isAuthorizedDoctorForPatient(patientId) || isAdmin()) && isValidDocumentSize();
      }
      
       match /prescriptions/{prescriptionId} {
        allow read: if canAccessPatientData(patientId);
        allow write: if (isAuthorizedDoctorForPatient(patientId) || isAdmin()) 
          && isValidDocumentSize()
          && isValidStringLength(request.resource.data.prescriptionNumber, 50);
      }
    }

    /**
     * @description Publicly readable collection of all appointments (Doctors Only)
     */
     match /appointments/{appointmentId} {
       allow read: if isDoctor() || isAdmin();
       allow write: if false; 
     }

     /**
      * @description Denormalized prescriptions (Admins Only)
      */
     match /prescriptions/{prescriptionId} {
       allow read, list: if isAdmin();
       allow write: if false; 
     }

    /**
     * @description Manages doctor profiles.
     */
    match /doctors/{doctorId} {
      allow get, list: if isSignedIn();
      allow create: if isOwner(doctorId) 
        && isValidDocumentSize();
      allow update: if isOwner(doctorId) || isAdmin();
      allow delete: if isAdmin();
      
      match /authorizedPatients/{patientId} {
        allow write: if isAdmin();
        allow read: if isAuthorizedDoctorForPatient(patientId);
      }

      match /services/{serviceId} {
        allow read: if isSignedIn();
        allow write: if isOwner(doctorId) || isAdmin();
      }
    }

    /**
     * @description Master list of all treatments.
     */
    match /treatments/{treatmentId} {
      allow get, list: if isSignedIn();
      allow write: if isAdmin();
    }

    /**
     * @description Stores leads from contact forms.
     */
    match /leads/{leadId} {
      allow read, list: if isAdmin();
      allow create: if true
        && isValidDocumentSize()
        && isValidStringLength(request.resource.data.name, 200)
        && isValidStringLength(request.resource.data.message, 5000)
        && noScriptTags(request.resource.data.name)
        && noScriptTags(request.resource.data.message);
      allow update, delete: if isAdmin();
    }

    /**
     * @description Public FAQs
     */
    match /faqs/{faqId} {
      allow get, list: if true;
      allow write: if isAdmin();
    }

    /**
     * @description WebRTC Video Calls
     */
    match /video-calls/{roomId} {
      allow read, write: if isSignedIn() && (isAuthorizedDoctorForPatient(resource.data.patientId) || isOwner(resource.data.patientId));
    }
    
     /**
     * @description Chat rooms
     */
    match /chatRooms/{roomId} {
      allow read, update: if isSignedIn() && request.auth.uid in resource.data.participants;
      allow create: if isDoctor();

      match /messages/{messageId} {
        allow get, list: if isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/chatRooms/$(roomId)).data.participants;
        allow create: if isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/chatRooms/$(roomId)).data.participants
                      && get(/databases/$(database)/documents/chatRooms/$(roomId)).data.status == 'open'
                      && isValidStringLength(request.resource.data.content, 10000)
                      && noScriptTags(request.resource.data.content);
        allow update: if isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/chatRooms/$(roomId)).data.participants;
      }
    }

    /**
     * @description Reports filed by doctors
     */
    match /reports/{reportId} {
      allow create: if isDoctor() 
        && isValidDocumentSize()
        && isValidStringLength(request.resource.data.reason, 5000);
      allow read, write: if isAdmin();
    }

    /**
     * @description Stores ratings for consultations.
     */
    match /ratings/{ratingId} {
      allow create: if isSignedIn()
         && isValidDocumentSize()
         && request.resource.data.rating >= 1
         && request.resource.data.rating <= 5;
      allow read, list: if isAdmin();
    }
  }
}
